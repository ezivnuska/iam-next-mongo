# Connection Monitoring Flow Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BROWSER (Client)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Poker Page                                                    â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ usePlayerConnectionMonitor                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Monitors page visibility                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Sends heartbeat every 10s â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Warns before navigation          â”‚                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                         â”‚                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ PlayerConnectionStatus              â”‚                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                     â”‚                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  ğŸŸ¢ Connected (<15s)                â”‚                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  ğŸŸ¡ Reconnecting (15-30s)           â”‚                â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ”´ Disconnected (>30s)             â”‚                â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Heartbeat POST /api/poker/heartbeat
                                    â”‚ every 10 seconds
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVER (Next.js API)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /api/poker/heartbeat                                          â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  â€¢ Receives heartbeat from client                            â”‚  â”‚
â”‚  â”‚  â€¢ Updates player.lastHeartbeat timestamp                    â”‚  â”‚
â”‚  â”‚  â€¢ Returns success/failure                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Background Monitor (runs every 10s)                           â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  1. Find all active games (locked=true, no winner)           â”‚  â”‚
â”‚  â”‚  2. For each game, check current player:                     â”‚  â”‚
â”‚  â”‚     - Is lastHeartbeat > 30s ago?                            â”‚  â”‚
â”‚  â”‚     - Is it their turn?                                      â”‚  â”‚
â”‚  â”‚     - Has action timer expired?                              â”‚  â”‚
â”‚  â”‚  3. If yes to all â†’ Auto-fold player                         â”‚  â”‚
â”‚  â”‚  4. Emit notification to all players                         â”‚  â”‚
â”‚  â”‚  5. Advance to next player                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Socket.IO events
                                    â”‚ (POKER_STATE_UPDATE, etc.)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE (MongoDB)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  poker_games collection:                                             â”‚
â”‚  {                                                                    â”‚
â”‚    code: "ABC123",                                                   â”‚
â”‚    locked: true,                                                     â”‚
â”‚    currentPlayerIndex: 0,                                            â”‚
â”‚    players: [                                                        â”‚
â”‚      {                                                               â”‚
â”‚        id: "user1",                                                  â”‚
â”‚        username: "Alice",                                            â”‚
â”‚        lastHeartbeat: ISODate("2025-11-02T10:30:45Z"),  â—„â”€â”€ Updated â”‚
â”‚        folded: false                                                 â”‚
â”‚      },                                                              â”‚
â”‚      {                                                               â”‚
â”‚        id: "user2",                                                  â”‚
â”‚        username: "Bob",                                              â”‚
â”‚        lastHeartbeat: ISODate("2025-11-02T10:29:30Z"),  â—„â”€â”€ Stale!  â”‚
â”‚        folded: false                                                 â”‚
â”‚      }                                                               â”‚
â”‚    ]                                                                 â”‚
â”‚  }                                                                   â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timeline: Player Disconnects During Their Turn

```
Time    Event                                   Client State      Server Action
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0s    Player closes tab/loses connection      Disconnected      -

T+10s   Heartbeat #1 missed                     -                 (no update)

T+15s   Monitor check                           -                 lastHeartbeat=15s
                                                                  Status: "reconnecting"

T+20s   Heartbeat #2 missed                     -                 (no update)

T+30s   Monitor check                           -                 lastHeartbeat=30s
                                                                  Status: "disconnected"
                                                                  âœ… AUTO-FOLD triggered

T+30s   Fold executed                           -                 â€¢ Mark player.folded=true
                                                                  â€¢ Add to actionHistory
                                                                  â€¢ Advance to next player
                                                                  â€¢ Save game

T+31s   Socket emission                         -                 Emit POKER_STATE_UPDATE
                                                                  Emit POKER_GAME_NOTIFICATION

T+31s   All clients receive update              Updated UI        Shows:
                                                                  "Bob was auto-folded
                                                                  (disconnected)"

T+45s   Original player reconnects              Reconnecting      Receives current state
                                                                  Sees they were folded

T+46s   Heartbeat #3 sent                       Connected         Updates lastHeartbeat
                                                                  Player can continue watching
```

## State Machine: Connection Status

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  CONNECTED   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚  (< 15s)     â”‚          â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                  â”‚                  â”‚
         â”‚                  â”‚ Heartbeat        â”‚ Heartbeat
         â”‚                  â”‚ missed           â”‚ received
         â”‚                  â”‚                  â”‚
         â”‚                  â–¼                  â”‚
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â”‚           â”‚ RECONNECTING â”‚          â”‚
         â”‚           â”‚  (15-30s)    â”‚          â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
         â”‚                  â”‚                  â”‚
         â”‚                  â”‚ More time        â”‚
         â”‚                  â”‚ elapsed          â”‚
         â”‚                  â–¼                  â”‚
         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ DISCONNECTED â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚   (> 30s)    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ If current turn
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  AUTO-FOLD   â”‚
                     â”‚   EXECUTED   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Interaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PokerProvider                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ usePlayerConnectionMonitor                         â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ Every 10s: Send heartbeat                          â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ POST /api/poker/heartbeat                          â”‚    â”‚
â”‚  â”‚   { gameId: "ABC123" }                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Socket Event Handlers                              â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ Receive POKER_STATE_UPDATE                         â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ Update players state (includes lastHeartbeat)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â†“                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PlayerSlots                              â”‚
â”‚                                                              â”‚
â”‚  For each player:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Player Component                                   â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ PlayerConnectionStatus                             â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ Calculate status from lastHeartbeat                â”‚    â”‚
â”‚  â”‚   â†“                                                 â”‚    â”‚
â”‚  â”‚ Display indicator: ğŸŸ¢ ğŸŸ¡ ğŸ”´                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling & Edge Cases

### Case 1: Network Hiccup (Brief Disconnect)
```
T+0s:  Disconnect
T+5s:  Reconnect
Result: No auto-fold (< 30s threshold)
Status: Transitions to "reconnecting" briefly, then back to "connected"
```

### Case 2: Multiple Players Disconnect
```
Server monitors all players individually
Each player auto-folded independently when threshold reached
Game continues with remaining connected players
```

### Case 3: All Players Disconnect
```
Game remains in locked state
First player to reconnect sees current state
No auto-fold if no one is connected (game waits)
```

### Case 4: Disconnect Not During Turn
```
Player disconnects while waiting
No auto-fold triggered (only auto-fold on current player's turn)
Player can reconnect anytime and continue
```

### Case 5: Timer Running When Disconnect Occurs
```
Player disconnects at T+0s
Action timer expires at T+25s
Auto-action from timer takes precedence (folds at T+25s)
Connection monitor respects timer, doesn't double-fold
```

## Data Flow: Heartbeat System

```
Client                          Server                      Database
â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€

[Every 10s]
  â”‚
  â”œâ”€â–º POST /api/poker/heartbeat
  â”‚     { gameId: "ABC123" }
  â”‚                               â”‚
  â”‚                               â”œâ”€â–º Get session (auth)
  â”‚                               â”‚
  â”‚                               â”œâ”€â–º db.collection('poker_games')
  â”‚                               â”‚     .updateOne(
  â”‚                               â”‚       { code: "ABC123",
  â”‚                               â”‚         'players.id': userId },
  â”‚                               â”‚       { $set: {
  â”‚                               â”‚         'players.$.lastHeartbeat': new Date()
  â”‚                               â”‚       }}
  â”‚                               â”‚     )
  â”‚                               â”‚                           â”‚
  â”‚                               â”‚                           â”œâ”€â–º Update timestamp
  â”‚                               â”‚                           â”‚
  â”‚                               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€ { success: true } â”€â”€â”¤
  â”‚

[Background Job - Every 10s]
                                  â”‚
                                  â”œâ”€â–º Find active games
                                  â”‚
                                  â”œâ”€â–º For each game:
                                  â”‚     Check current player
                                  â”‚
                                  â”œâ”€â–º If lastHeartbeat > 30s:
                                  â”‚     â€¢ autoFoldDisconnectedPlayer()
                                  â”‚     â€¢ Emit socket events
                                  â”‚                           â”‚
                                  â”‚                           â”œâ”€â–º Update game state
                                  â”‚                           â”‚   Set player.folded = true
                                  â”‚                           â”‚   Advance turn
                                  â”‚                           â”‚
                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€Socket.IOâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                                  â”‚   POKER_STATE_UPDATE
                                  â”‚
Client receives update â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Updates UI with folded player
```

## Security Flow

```
Heartbeat Request
       â”‚
       â”œâ”€â”€â–º Check session authentication
       â”‚    â”œâ”€ No session? â†’ 401 Unauthorized
       â”‚    â””â”€ Has session? â†’ Continue
       â”‚
       â”œâ”€â”€â–º Validate gameId parameter
       â”‚    â”œâ”€ Missing? â†’ 400 Bad Request
       â”‚    â””â”€ Present? â†’ Continue
       â”‚
       â”œâ”€â”€â–º Verify player in game
       â”‚    â”œâ”€ Not in game? â†’ 404 Not Found
       â”‚    â””â”€ In game? â†’ Continue
       â”‚
       â””â”€â”€â–º Update lastHeartbeat
            â””â”€ 200 OK
```
